var kAPI = ""
var selectVar= "";
var request = new XMLHttpRequest();
var inputVar = document.createElement("input")
var valu_d
var opt
var url_push = 'https://liveobjects.orange-business.com/api/v0/event2action/actionPolicies';
inputVar.setAttribute('type','text')
inputVar.setAttribute('id','hiddenInput')
document.getElementById('condi').appendChild(inputVar)
function submit_api() {
   kAPI = document.forms["formAPI"]["inputApi"].value;
   var roles =[];
   const request_api_key = new XMLHttpRequest();
   request_api_key.open('GET', 'https://liveobjects.orange-business.com/api/v0/apiKeys/current_key', false);
   request_api_key.setRequestHeader('Accept', 'application/json');
   request_api_key.setRequestHeader('Content-type', 'application/json');
   request_api_key.setRequestHeader('X-API-KEY', kAPI);
   request_api_key.send(null);
   if (request_api_key.status === 200) {
       var result = JSON.parse(request_api_key.response);
       roles = result.roles;
        getDevices();
        // addCode()
        gestion();
   } else {
       console.log("Status de la réponse: %d (%s)", request_api_key.status, request_api_key.statusText);
   }

}


function getDevices(){
 var url_data = 'https://liveobjects.orange-business.com/api/v0/data/streams/';
 var request_data = new XMLHttpRequest();
 request.open('GET', 'https://liveobjects.orange-business.com/api/v0/assets?size=20&page=0', false);
 request.setRequestHeader('Accept', 'application/json');
 request.setRequestHeader('Content-type', 'application/json');
 request.setRequestHeader('X-API-KEY', kAPI);
 request.send(null);
 var url_device =[];        var val=[] ; var lav = []
   if (request.status >= 200 && request.status < 400) {
     var valu = JSON.parse(request.response);
     var options=""
        for (var i = 0; i < valu.data.length; i++) {
            var mydev = valu.data[i].name;
            var namespace = valu.data[i].namespace;
            var idd = valu.data[i].id;
            url_device.push(url_data+namespace+idd);
            // options+="<option value=\""+mydev+"\">"+mydev+"</option>";
            // document.getElementById('id_devices').innerHTML=options;
        }
        for (var j = 0; j < url_device.length; j++) {
          request_data.open('GET', url_device[j], false);
          request_data.setRequestHeader('Accept', 'application/json')
          request_data.setRequestHeader('Content-type', 'application/json')
          request_data.setRequestHeader('X-API-KEY', kAPI)
          request_data.onload = function () { //function pour les data des devices
           valu_d = JSON.parse(this.response);
            if (request_data.status == 200) {
                 for (var variable in valu_d[j]) {
                   var myVal = variable;
                   opt = document.createElement("option");
                   opt.value= myVal;
                   opt.innerHTML = myVal;
                   document.getElementsByClassName('cond')[0].appendChild(opt);
                 }
                 for (var variable2 in valu_d[j].value) {
                   var myVal2 = variable2;
                   var opt2 = document.createElement("option");
                   opt2.value= myVal2;
                   opt2.innerHTML = myVal2;
                   document.getElementById('newSel').appendChild(opt2);
                 }
                 // for (var variable3 in valu_d[j].location) {
                 //   var myVal3 = variable3;
                 //   var opt3 = document.createElement("option");
                 //   opt3.value= myVal3;
                 //   opt3.innerHTML = myVal3;
                 //   document.getElementById('newSel').appendChild(opt3);
                 // }
            }else {
              console.log("Ce device n'a envoyé aucune donnée pour l'instant. ");
            }
          }
          request_data.send();
        }
    }else{
      console.log('error getting device');
    }
}
function showData() {
     var theSelect = form1.cond;
     selectVar = theSelect[theSelect.selectedIndex].text;
     inputVar.setAttribute('value', selectVar)
     if (isObject(valu_d[0].value)) {
       var newOpt = document.createElement("option")
       document.getElementById('newSel').appendChild(newOpt);
       document.getElementById('newSel').style.display = 'inline';

     }
}
function isObject(o) {
  return o !== null && typeof o === 'object' && Array.isArray(o) === false;
}
document.getElementById("addLine").onclick = duplicate;
var i = 0;
var original = document.getElementById('duplicater');

function duplicate() {
    var clone = original.cloneNode(true); // "deep" clone
    clone.id = "duplicetor" + ++i;
    original.parentNode.appendChild(clone);
}

// document.getElementById("addLine").onclick = function () {
//     var ok = true;
//
//      if (ok === true) {
//           var select = document.createElement('select');
//           var input = document.createElement('input');
//           var add = document.createElement('button');
//           var ico = document.createElement('i');
//           input.setAttribute('class', 'form-control')
//           input.setAttribute('name', 'free')
//           input.setAttribute('placeholder', 'value')
//           select.setAttribute('class', 'form-control')
//           select.setAttribute('name', 'cond')
//           select.setAttribute('onchange', 'showData()')
//           add.setAttribute('type', 'reset')
//           add.setAttribute('class', 'btn btn-warning btnAdd')
//           add.setAttribute('id', 'addId')
//           ico.setAttribute('class', 'fa fa-plus')
//           var div = document.createElement('div')
//           div.setAttribute('class', 'form-inline')
//           div.setAttribute('id', 'di')
//           var rangee = document.createElement('div')
//           rangee.setAttribute('class', 'col-sm-6')
//           rangee.setAttribute('id', 'range')
//           add.appendChild(ico);
//           document.getElementById('rangee').appendChild(input);
//           document.getElementById('rangee').appendChild(select);
//           document.getElementById('rangee').appendChild(add);
//           div.appendChild(rangee);
//           // document.getElementsByClassName('cond')[1].appendChild(opt);
//
//
//     }
// };
function push_http(name,url,value,free,sensor){
    var req_http = new XMLHttpRequest();

    var req =    '{"name": "'+name+'","enabled": true,"triggers": { "messageSelector": {"origin": "data_new"} }, "actions": { "httpPush": [{"webhookUrl": "'+url+'","retryOnFailure": true,"content": "{ \\"'+value+'\\" : \\"{{'+free+'.'+sensor+'}}\\" }" }] }}'
    console.log(req);
    req_http.open('POST', url_push, true);
    req_http.setRequestHeader('Accept', 'application/json');
    req_http.setRequestHeader('Content-type', 'application/json');
    req_http.setRequestHeader('X-API-KEY', kAPI);
    req_http.send(req);
    req_http.onreadystatechange = function(){
     if (req_http.status >= 200 && req_http.readyState == 4) {
       var json_reponse = JSON.parse(req_http.response);
       console.log("HTTP Push cree avec succes");
       console.log(json_reponse.id);
       // matching_id = json_reponse.id;
       //  firing_rule(firingType, matching_id,nameE);
      }
   }
}
function validation(){
  var e = document.getElementById("condi");
  free = e.options[e.selectedIndex].value;
  var f = document.getElementById("newSel");
  sensor = f.options[f.selectedIndex].value; // get the sensor from the sensors list


   url = document.getElementById("url").value;
   val1 = document.getElementById("inputVal").value;
  return true;
}
function submit_by_id() {
  var url = document.getElementById("url").value;
  var val1 = document.getElementById("inputVal").value;
  var nameE = document.getElementById("pushName").value;
  if (validation()) // Calling validation function
    {
    push_http(nameE,url,val1,free,sensor)
    alert("Action Pushed.");
    document.getElementById("form1").submit(); //form submission

  }else{
    alert("not valid");
  }
}

function gestion(){
 request.open('GET', url_push, false);
 request.setRequestHeader('Accept', 'application/json')
 request.setRequestHeader('Content-type', 'application/json')
 request.setRequestHeader('X-API-KEY', kAPI)
 request.onload = function () {
   var valu = JSON.parse(request.response);
   if (request.status >= 200 && request.status < 400) {
        for (var i = 0; i < valu.data.length; i++) {
          alertes = valu.data[i].name;
          alerteId = valu.data[i].id;
          var tr = document.createElement("tr");
          var td = document.createElement('td');
          var tdDelete = document.createElement("td");
          // var tdAction = document.createElement("td");
          var colId = '<td align="center"><span class="idToDelete" id="'+alerteId+'"><button title="" type="button" class="btn btn-danger remove show_tip" data-original-title="Delete"><i class="fa fa-trash-o"></i></button></span></td>';
          td.innerHTML = alertes;
          tdDelete.innerHTML = colId;
          tr.appendChild(td);
          tr.appendChild(tdDelete);
          document.getElementById('bod').appendChild(tr);
        }
      }
    }
    request.send();
}
